@model CarRentalSystem.Entities.Rentals.Payment

@{
    ViewData["Title"] = "Record New Payment";
    var rentalInfo = ViewBag.Rental as CarRentalSystem.Entities.Rentals.Rental;
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold mb-0">
                <i class="fas fa-money-bill-wave text-success"></i> Record New Payment
            </h1>
            <p class="text-muted">Add a payment transaction to a rental</p>
        </div>
    </div>

    <!-- Back Button -->
    <div class="mb-3">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>

    <div class="row">
        <!-- Payment Form -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle"></i> Payment Information
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- Rental Selection -->
                        @if (ViewBag.RentalId != null)
                        {
                            <input type="hidden" asp-for="RentalId" value="@ViewBag.RentalId" />
                            <div class="mb-3">
                                <label class="form-label">Selected Rental</label>
                                <div class="alert alert-info">
                                    <strong>Rental #@ViewBag.RentalId</strong>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="mb-3">
                                <label asp-for="RentalId" class="form-label">Select Rental</label>
                                <select asp-for="RentalId" class="form-select" id="rentalSelect" required>
                                    <option value="">-- Select a rental --</option>
                                    @if (ViewBag.Rentals != null)
                                    {
                                        @foreach (var rental in ViewBag.Rentals as SelectList)
                                        {
                                            <option value="@rental.Value">Rental #@rental.Value</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="RentalId" class="text-danger"></span>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> Select an active or reserved rental
                                </small>
                            </div>
                        }

                        <!-- Payment Date -->
                        <div class="mb-3">
                            <label asp-for="PaymentDate" class="form-label">Payment Date</label>
                            <input asp-for="PaymentDate" type="date" class="form-control" required />
                            <span asp-validation-for="PaymentDate" class="text-danger"></span>
                        </div>

                        <!-- Amount -->
                        <div class="mb-3">
                            <label asp-for="Amount" class="form-label">Payment Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="Amount" type="number" step="0.01" min="0.01" 
                                       class="form-control" id="paymentAmount" required />
                            </div>
                            <span asp-validation-for="Amount" class="text-danger"></span>
                            <small class="form-text text-muted" id="amountHint">
                                <i class="fas fa-info-circle"></i> Enter the payment amount
                            </small>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-3">
                            <label asp-for="PaymentMethod" class="form-label">Payment Method</label>
                            <select asp-for="PaymentMethod" class="form-select" required>
                                @foreach (var method in Enum.GetValues<CarRentalSystem.Entities.Rentals.PaymentMethod>())
                                {
                                    <option value="@method">@method</option>
                                }
                            </select>
                            <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                        </div>

                        <!-- Payment Status -->
                        <div class="mb-3">
                            <label asp-for="Status" class="form-label">Payment Status</label>
                            <select asp-for="Status" class="form-select" required>
                                @foreach (var status in Enum.GetValues<CarRentalSystem.Entities.Rentals.PaymentStatus>())
                                {
                                    <option value="@status">@status</option>
                                }
                            </select>
                            <span asp-validation-for="Status" class="text-danger"></span>
                        </div>

                        <hr />

                        <!-- Form Actions -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> Record Payment
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Rental Information Panel -->
        <div class="col-lg-6">
            @if (rentalInfo != null)
            {
                <!-- Static rental info when rentalId is provided -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-file-contract"></i> Rental Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Client:</dt>
                            <dd class="col-sm-8">
                                @if (rentalInfo.Client != null)
                                {
                                    <span>@rentalInfo.Client.FirstName @rentalInfo.Client.LastName</span>
                                }
                            </dd>

                            <dt class="col-sm-4">Vehicle:</dt>
                            <dd class="col-sm-8">
                                @if (rentalInfo.Car?.Model?.Brand != null)
                                {
                                    <span>@rentalInfo.Car.Model.Brand.BrandName @rentalInfo.Car.Model.ModelName</span>
                                    <br />
                                    <small class="text-muted">@rentalInfo.Car.RegistrationNumber</small>
                                }
                            </dd>

                            <dt class="col-sm-4">Daily Rate:</dt>
                            <dd class="col-sm-8"><strong>@rentalInfo.Car?.DailyPrice.ToString("C")</strong></dd>

                            <dt class="col-sm-4">Rental Period:</dt>
                            <dd class="col-sm-8">
                                @rentalInfo.RentalDate.ToString("MMM dd, yyyy")
                                @if (rentalInfo.ReturnDate.HasValue)
                                {
                                    <span> - @rentalInfo.ReturnDate.Value.ToString("MMM dd, yyyy")</span>
                                }
                            </dd>

                            @{
                                var rentalDays = rentalInfo.ReturnDate.HasValue
                                    ? (rentalInfo.ReturnDate.Value - rentalInfo.RentalDate).Days
                                    : (DateTime.Now - rentalInfo.RentalDate).Days;
                                if (rentalDays < 1) rentalDays = 1;
                                var totalCost = rentalInfo.Car?.DailyPrice * rentalDays ?? 0;
                                var totalPaid = rentalInfo.Payments?
                                    .Where(p => p.Status == CarRentalSystem.Entities.Rentals.PaymentStatus.Completed)
                                    .Sum(p => p.Amount) ?? 0;
                                var remaining = totalCost - totalPaid;
                            }

                            <dt class="col-sm-4">Total Cost:</dt>
                            <dd class="col-sm-8">
                                <strong>@totalCost.ToString("C")</strong>
                                <br />
                                <small class="text-muted">(@rentalDays days)</small>
                            </dd>

                            <dt class="col-sm-4">Total Paid:</dt>
                            <dd class="col-sm-8"><span class="text-success">@totalPaid.ToString("C")</span></dd>

                            <dt class="col-sm-4">Remaining:</dt>
                            <dd class="col-sm-8 mb-0">
                                <strong class="@(remaining > 0 ? "text-danger" : "text-success")">
                                    @remaining.ToString("C")
                                </strong>
                            </dd>
                        </dl>
                    </div>
                </div>
            }
            else
            {
                <!-- Dynamic rental info when rental is selected from dropdown -->
                <div class="card shadow-sm mb-3" id="rentalInfoCard" style="display: none;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-file-contract"></i> Rental Information
                        </h5>
                    </div>
                    <div class="card-body" id="rentalInfoContent">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Payment Tips -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb"></i> Payment Tips
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Verify the rental information before recording payment</li>
                        <li>Check the remaining balance to avoid overpayment</li>
                        <li>Use "Completed" status for confirmed payments</li>
                        <li>Use "Pending" status for unconfirmed transactions</li>
                        <li>Partial payments are allowed for flexible payment plans</li>
                        <li>Record the actual payment date for accurate tracking</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Load rental information when rental is selected
            $('#rentalSelect').change(function() {
                var rentalId = $(this).val();
                if (rentalId) {
                    $('#rentalInfoCard').show();
                    $('#rentalInfoContent').html('<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');
                    
                    $.ajax({
                        url: '@Url.Action("GetRentalInfo", "Payments")',
                        type: 'GET',
                        data: { rentalId: rentalId },
                        success: function(data) {
                            if (data.success) {
                                var rentalDays = data.rentalDays;
                                var totalCost = data.totalCost;
                                var totalPaid = data.totalPaid;
                                var remaining = data.remainingAmount;
                                
                                var html = '<dl class="row mb-0">';
                                html += '<dt class="col-sm-4">Client:</dt>';
                                html += '<dd class="col-sm-8">' + data.clientName + '</dd>';
                                
                                html += '<dt class="col-sm-4">Vehicle:</dt>';
                                html += '<dd class="col-sm-8">' + data.carInfo + '<br/><small class="text-muted">' + data.registrationNumber + '</small></dd>';
                                
                                html += '<dt class="col-sm-4">Daily Rate:</dt>';
                                html += '<dd class="col-sm-8"><strong>$' + data.dailyPrice.toFixed(2) + '</strong></dd>';
                                
                                html += '<dt class="col-sm-4">Rental Period:</dt>';
                                html += '<dd class="col-sm-8">' + data.rentalDate;
                                if (data.returnDate) {
                                    html += ' - ' + data.returnDate;
                                }
                                html += '</dd>';
                                
                                html += '<dt class="col-sm-4">Total Cost:</dt>';
                                html += '<dd class="col-sm-8"><strong>$' + totalCost.toFixed(2) + '</strong><br/><small class="text-muted">(' + rentalDays + ' days)</small></dd>';
                                
                                html += '<dt class="col-sm-4">Total Paid:</dt>';
                                html += '<dd class="col-sm-8"><span class="text-success">$' + totalPaid.toFixed(2) + '</span></dd>';
                                
                                html += '<dt class="col-sm-4">Remaining:</dt>';
                                html += '<dd class="col-sm-8 mb-0"><strong class="' + (remaining > 0 ? 'text-danger' : 'text-success') + '">$' + remaining.toFixed(2) + '</strong></dd>';
                                html += '</dl>';
                                
                                $('#rentalInfoContent').html(html);
                                
                                // Suggest remaining amount
                                if (remaining > 0) {
                                    $('#paymentAmount').val(remaining.toFixed(2));
                                    $('#amountHint').html('<i class="fas fa-info-circle"></i> Suggested amount: $' + remaining.toFixed(2) + ' (remaining balance)');
                                }
                            } else {
                                $('#rentalInfoContent').html('<div class="alert alert-danger">' + data.message + '</div>');
                            }
                        },
                        error: function() {
                            $('#rentalInfoContent').html('<div class="alert alert-danger">Failed to load rental information</div>');
                        }
                    });
                } else {
                    $('#rentalInfoCard').hide();
                    $('#amountHint').html('<i class="fas fa-info-circle"></i> Enter the payment amount');
                }
            });
        });
    </script>
}
