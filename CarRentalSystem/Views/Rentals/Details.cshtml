@model CarRentalSystem.Entities.Rentals.Rental

@{
    ViewData["Title"] = $"Rental Details - #{Model.Id}";
    var rentalDays = Model.ReturnDate.HasValue
        ? (Model.ReturnDate.Value - Model.RentalDate).Days
        : (DateTime.Now - Model.RentalDate).Days;
    if (rentalDays < 1) rentalDays = 1;
    var totalCost = Model.Car?.DailyPrice * rentalDays ?? 0;
    var totalPaid = Model.Payments?
        .Where(p => p.Status == CarRentalSystem.Entities.Rentals.PaymentStatus.Completed)
        .Sum(p => p.Amount) ?? 0;
    var remaining = totalCost - totalPaid;
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold mb-0">
                <i class="fas fa-file-contract text-primary"></i> Rental Details
            </h1>
            <p class="text-muted">Comprehensive rental transaction information</p>
        </div>
    </div>

    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Action Buttons -->
    <div class="mb-3">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
        @if (Model.Status != CarRentalSystem.Entities.Rentals.RentalStatus.Completed &&
            Model.Status != CarRentalSystem.Entities.Rentals.RentalStatus.Cancelled)
        {
            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">
                <i class="fas fa-edit"></i> Edit
            </a>
        }
        @if (Model.Status == CarRentalSystem.Entities.Rentals.RentalStatus.Active)
        {
            <a asp-action="Return" asp-route-id="@Model.Id" class="btn btn-success">
                <i class="fas fa-check"></i> Return Vehicle
            </a>
        }
        @if (Model.Status != CarRentalSystem.Entities.Rentals.RentalStatus.Completed &&
            Model.Status != CarRentalSystem.Entities.Rentals.RentalStatus.Cancelled)
        {
            <a asp-action="Cancel" asp-route-id="@Model.Id" class="btn btn-danger">
                <i class="fas fa-times-circle"></i> Cancel Rental
            </a>
        }
        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-outline-danger">
            <i class="fas fa-trash"></i> Delete
        </a>
        <a asp-controller="Payments" asp-action="Create" asp-route-rentalId="@Model.Id" class="btn btn-primary">
            <i class="fas fa-dollar-sign"></i> Add Payment
        </a>
    </div>

    <div class="row">
        <!-- Main Information Column -->
        <div class="col-lg-8">
            <!-- Rental Overview -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Rental Overview
                        <span class="badge bg-light text-dark float-end">ID: #@Model.Id</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="fw-bold text-muted mb-3">Rental Period</h6>
                            <dl class="row">
                                <dt class="col-sm-5">Start Date:</dt>
                                <dd class="col-sm-7">
                                    <strong>@Model.RentalDate.ToString("MMMM dd, yyyy")</strong>
                                </dd>

                                <dt class="col-sm-5">Return Date:</dt>
                                <dd class="col-sm-7">
                                    @if (Model.ReturnDate.HasValue)
                                    {
                                        <strong>@Model.ReturnDate.Value.ToString("MMMM dd, yyyy")</strong>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">Not returned yet</span>
                                    }
                                </dd>

                                <dt class="col-sm-5">Duration:</dt>
                                <dd class="col-sm-7 mb-0">
                                    <span class="badge bg-info">@rentalDays day(s)</span>
                                </dd>
                            </dl>
                        </div>

                        <div class="col-md-6">
                            <h6 class="fw-bold text-muted mb-3">Financial Summary</h6>
                            <dl class="row">
                                <dt class="col-sm-5">Daily Rate:</dt>
                                <dd class="col-sm-7">
                                    <strong>@Model.Car?.DailyPrice.ToString("C")</strong>
                                </dd>

                                <dt class="col-sm-5">Total Cost:</dt>
                                <dd class="col-sm-7">
                                    <strong class="text-primary">@totalCost.ToString("C")</strong>
                                </dd>

                                <dt class="col-sm-5">Total Paid:</dt>
                                <dd class="col-sm-7">
                                    <strong class="text-success">@totalPaid.ToString("C")</strong>
                                </dd>

                                <dt class="col-sm-5">Remaining:</dt>
                                <dd class="col-sm-7 mb-0">
                                    <strong class="@(remaining > 0 ? "text-danger" : "text-success")">
                                        @remaining.ToString("C")
                                    </strong>
                                </dd>
                            </dl>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h6 class="fw-bold text-muted mb-2">Current Status</h6>
                            @switch (Model.Status)
                            {
                                case CarRentalSystem.Entities.Rentals.RentalStatus.Reserved:
                                    <span class="badge bg-info fs-6">
                                        <i class="fas fa-bookmark"></i> Reserved
                                    </span>
                                    <p class="text-muted mt-2 mb-0">Vehicle is reserved for this client</p>
                                    break;
                                case CarRentalSystem.Entities.Rentals.RentalStatus.Active:
                                    <span class="badge bg-warning text-dark fs-6">
                                        <i class="fas fa-car"></i> Active
                                    </span>
                                    <p class="text-muted mt-2 mb-0">Vehicle is currently with the client</p>
                                    break;
                                case CarRentalSystem.Entities.Rentals.RentalStatus.Completed:
                                    <span class="badge bg-success fs-6">
                                        <i class="fas fa-check-circle"></i> Completed
                                    </span>
                                    <p class="text-muted mt-2 mb-0">Rental has been completed and vehicle returned</p>
                                    break;
                                case CarRentalSystem.Entities.Rentals.RentalStatus.Cancelled:
                                    <span class="badge bg-secondary fs-6">
                                        <i class="fas fa-ban"></i> Cancelled
                                    </span>
                                    <p class="text-muted mt-2 mb-0">Rental has been cancelled</p>
                                    break;
                                case CarRentalSystem.Entities.Rentals.RentalStatus.Overdue:
                                    <span class="badge bg-danger fs-6">
                                        <i class="fas fa-exclamation-triangle"></i> Overdue
                                    </span>
                                    <p class="text-muted mt-2 mb-0">Vehicle return is overdue</p>
                                    break;
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user"></i> Client Information
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Client != null)
                    {
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4">Name:</dt>
                                    <dd class="col-sm-8">
                                        <strong>@Model.Client.FirstName @Model.Client.LastName</strong>
                                    </dd>

                                    <dt class="col-sm-4">Email:</dt>
                                    <dd class="col-sm-8">
                                        <a href="mailto:@Model.Client.Email">@Model.Client.Email</a>
                                    </dd>

                                    <dt class="col-sm-4">Phone:</dt>
                                    <dd class="col-sm-8 mb-0">
                                        <a href="tel:@Model.Client.PhoneNumber">@Model.Client.PhoneNumber</a>
                                    </dd>
                                </dl>
                            </div>

                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4">PESEL:</dt>
                                    <dd class="col-sm-8">@Model.Client.PESEL</dd>

                                    <dt class="col-sm-4">Address:</dt>
                                    <dd class="col-sm-8 mb-0">
                                        @Model.Client.City, @Model.Client.PostalCode
                                    </dd>
                                </dl>
                            </div>
                        </div>

                        <div class="mt-3">
                            <a asp-controller="Clients" asp-action="Details" asp-route-id="@Model.Client.Id" 
                               class="btn btn-sm btn-outline-info">
                                <i class="fas fa-external-link-alt"></i> View Full Client Profile
                            </a>
                        </div>
                    }
                </div>
            </div>

            <!-- Vehicle Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header" style="background-color: #28a745; color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-car"></i> Vehicle Information
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Car?.Model?.Brand != null)
                    {
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-5">Brand:</dt>
                                    <dd class="col-sm-7">
                                        <strong>@Model.Car.Model.Brand.BrandName</strong>
                                    </dd>

                                    <dt class="col-sm-5">Model:</dt>
                                    <dd class="col-sm-7">
                                        <strong>@Model.Car.Model.ModelName</strong>
                                    </dd>

                                    <dt class="col-sm-5">Registration:</dt>
                                    <dd class="col-sm-7">
                                        <span class="badge bg-dark">@Model.Car.RegistrationNumber</span>
                                    </dd>

                                    <dt class="col-sm-5">Daily Rate:</dt>
                                    <dd class="col-sm-7 mb-0">
                                        <strong class="text-success">@Model.Car.DailyPrice.ToString("C")</strong>
                                    </dd>
                                </dl>
                            </div>

                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-5">Year:</dt>
                                    <dd class="col-sm-7">@Model.Car.Model.Brand.Year</dd>

                                    <dt class="col-sm-5">Body Type:</dt>
                                    <dd class="col-sm-7">@Model.Car.Model.Brand.BodyType</dd>

                                    <dt class="col-sm-5">Transmission:</dt>
                                    <dd class="col-sm-7">@Model.Car.Model.Brand.Transmission</dd>

                                    <dt class="col-sm-5">Mileage:</dt>
                                    <dd class="col-sm-7 mb-0">
                                        @Model.Car.Mileage.ToString("N0") km
                                    </dd>
                                </dl>
                            </div>
                        </div>

                        <div class="mt-3">
                            <a asp-controller="Cars" asp-action="Details" asp-route-id="@Model.Car.Id" 
                               class="btn btn-sm btn-outline-success">
                                <i class="fas fa-external-link-alt"></i> View Full Vehicle Details
                            </a>
                        </div>

                        @if (Model.Car.Insurance != null)
                        {
                            <hr />
                            <h6 class="fw-bold text-muted">Insurance Information</h6>
                            <div class="mb-2">
                                <span class="badge bg-info">@Model.Car.Insurance.Company</span>
                                <small class="text-muted">
                                    Policy: @Model.Car.Insurance.PolicyNumber
                                    (Valid: @Model.Car.Insurance.StartDate.ToString("MMM dd, yyyy") - @Model.Car.Insurance.EndDate.ToString("MMM dd, yyyy"))
                                </small>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Employee Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-tie"></i> Assigned Employee
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Employee != null)
                    {
                        <dl class="row mb-0">
                            <dt class="col-sm-3">Name:</dt>
                            <dd class="col-sm-9">
                                <strong>@Model.Employee.FirstName @Model.Employee.LastName</strong>
                            </dd>

                            <dt class="col-sm-3">Position:</dt>
                            <dd class="col-sm-9">@Model.Employee.Position</dd>

                            <dt class="col-sm-3">Phone:</dt>
                            <dd class="col-sm-9 mb-0">
                                <a href="tel:@Model.Employee.Phone">@Model.Employee.Phone</a>
                            </dd>
                        </dl>

                        <div class="mt-3">
                            <a asp-controller="Employees" asp-action="Details" asp-route-id="@Model.Employee.Id" 
                               class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-external-link-alt"></i> View Employee Profile
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Payments Column -->
        <div class="col-lg-4">
            <!-- Payment Summary -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-dollar-sign"></i> Payment Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Cost:</span>
                        <strong>@totalCost.ToString("C")</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Paid:</span>
                        <strong class="text-success">@totalPaid.ToString("C")</strong>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between">
                        <span><strong>Balance:</strong></span>
                        <strong class="@(remaining > 0 ? "text-danger" : "text-success")">
                            @remaining.ToString("C")
                        </strong>
                    </div>

                    @if (remaining > 0)
                    {
                        <div class="alert alert-warning mt-3 mb-0">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Payment Required:</strong> @remaining.ToString("C")
                        </div>
                    }
                    else if (remaining == 0 && totalPaid > 0)
                    {
                        <div class="alert alert-success mt-3 mb-0">
                            <i class="fas fa-check-circle"></i>
                            <strong>Fully Paid</strong>
                        </div>
                    }
                </div>
            </div>

            <!-- Payments List -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-receipt"></i> Payment Transactions
                        <span class="badge bg-light text-dark float-end">
                            @(Model.Payments?.Count ?? 0)
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Payments != null && Model.Payments.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var payment in Model.Payments.OrderByDescending(p => p.PaymentDate))
                            {
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold">Payment #@payment.Id</span>
                                        @switch (payment.Status)
                                        {
                                            case CarRentalSystem.Entities.Rentals.PaymentStatus.Completed:
                                                <span class="badge bg-success">Completed</span>
                                                break;
                                            case CarRentalSystem.Entities.Rentals.PaymentStatus.Pending:
                                                <span class="badge bg-warning text-dark">Pending</span>
                                                break;
                                            case CarRentalSystem.Entities.Rentals.PaymentStatus.Failed:
                                                <span class="badge bg-danger">Failed</span>
                                                break;
                                            case CarRentalSystem.Entities.Rentals.PaymentStatus.Refunded:
                                                <span class="badge bg-secondary">Refunded</span>
                                                break;
                                        }
                                    </div>
                                    <div class="small text-muted">
                                        <i class="fas fa-calendar"></i> @payment.PaymentDate.ToString("MMM dd, yyyy")
                                    </div>
                                    <div class="small text-muted">
                                        <i class="fas fa-credit-card"></i> @payment.PaymentMethod
                                    </div>
                                    <div class="mt-2">
                                        <strong class="text-success">@payment.Amount.ToString("C")</strong>
                                        <a asp-controller="Payments" asp-action="Details" asp-route-id="@payment.Id" 
                                           class="btn btn-sm btn-outline-info float-end">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="mb-0">No payments recorded yet</p>
                        </div>
                    }

                    <div class="mt-3">
                        <a asp-controller="Payments" asp-action="Create" asp-route-rentalId="@Model.Id" 
                           class="btn btn-primary w-100">
                            <i class="fas fa-plus"></i> Add Payment
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        @if (Model.Status == CarRentalSystem.Entities.Rentals.RentalStatus.Active)
                        {
                            <a asp-action="Return" asp-route-id="@Model.Id" class="btn btn-success">
                                <i class="fas fa-check"></i> Return Vehicle
                            </a>
                        }
                        @if (Model.Status != CarRentalSystem.Entities.Rentals.RentalStatus.Completed &&
                            Model.Status != CarRentalSystem.Entities.Rentals.RentalStatus.Cancelled)
                        {
                            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">
                                <i class="fas fa-edit"></i> Edit Rental
                            </a>
                            <a asp-action="Cancel" asp-route-id="@Model.Id" class="btn btn-danger">
                                <i class="fas fa-times-circle"></i> Cancel Rental
                            </a>
                        }
                        <a asp-controller="Payments" asp-action="Create" asp-route-rentalId="@Model.Id" class="btn btn-primary">
                            <i class="fas fa-dollar-sign"></i> Add Payment
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-dismiss alerts
        window.setTimeout(function() {
            $(".alert").fadeTo(500, 0).slideUp(500, function(){
                $(this).remove();
            });
        }, 5000);
    </script>
}
